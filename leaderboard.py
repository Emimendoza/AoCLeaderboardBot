import json
import aiohttp
import discord
from discord.ext import commands, tasks

foo = json.loads("""{"event":"2021","owner_id":"422097","members":{"614991":{"stars":0,"completion_day_level":{},"name":null,"id":"614991","global_score":0,"last_star_ts":"0","local_score":0},"981220":{"id":"981220","last_star_ts":"0","global_score":0,"local_score":0,"stars":0,"name":"Sai Fun","completion_day_level":{}},"988183":{"stars":1,"completion_day_level":{"1":{"1":{"get_star_ts":1638364767}}},"name":"Theodore Hua","id":"988183","last_star_ts":1638364767,"local_score":69,"global_score":0},"993004":{"stars":0,"completion_day_level":{},"name":"Abdul Kalam","id":"993004","last_star_ts":"0","local_score":0,"global_score":0},"1018836":{"last_star_ts":1638349216,"local_score":155,"global_score":0,"id":"1018836","completion_day_level":{"1":{"1":{"get_star_ts":1638348831},"2":{"get_star_ts":1638349216}}},"name":"P403n1x87","stars":2},"1567326":{"local_score":0,"last_star_ts":"0","global_score":0,"id":"1567326","completion_day_level":{},"name":"itachi uchiha","stars":0},"995369":{"completion_day_level":{},"name":"aconamos","stars":0,"last_star_ts":"0","local_score":0,"global_score":0,"id":"995369"},"1558421":{"local_score":174,"last_star_ts":1638337534,"global_score":0,"id":"1558421","completion_day_level":{"1":{"2":{"get_star_ts":1638337534},"1":{"get_star_ts":1638336443}}},"name":"LeoCx1000","stars":2},"377828":{"stars":2,"completion_day_level":{"1":{"2":{"get_star_ts":1638369722},"1":{"get_star_ts":1638369070}}},"name":"hclimente","id":"377828","last_star_ts":1638369722,"local_score":134,"global_score":0},"1411244":{"name":"eiyashou","completion_day_level":{"1":{"2":{"get_star_ts":1638335303},"1":{"get_star_ts":1638335036}}},"stars":2,"global_score":0,"last_star_ts":1638335303,"local_score":194,"id":"1411244"},"977889":{"stars":0,"completion_day_level":{},"name":"Rishikesan Varudharajan","id":"977889","global_score":0,"last_star_ts":"0","local_score":0},"991294":{"global_score":0,"last_star_ts":1638335410,"local_score":188,"id":"991294","completion_day_level":{"1":{"1":{"get_star_ts":1638335229},"2":{"get_star_ts":1638335410}}},"name":"RadioactiveHydra","stars":2},"982302":{"global_score":0,"last_star_ts":"0","local_score":0,"id":"982302","completion_day_level":{},"name":"Espiobest","stars":0},"1077227":{"completion_day_level":{},"name":"Robot Robotitzat","stars":0,"global_score":0,"last_star_ts":"0","local_score":0,"id":"1077227"},"977023":{"stars":0,"completion_day_level":{},"name":"tyHadd","id":"977023","last_star_ts":"0","local_score":0,"global_score":0},"978969":{"id":"978969","local_score":0,"last_star_ts":"0","global_score":0,"stars":0,"completion_day_level":{},"name":"soerili"},"1286830":{"name":"RandomGuyBay","completion_day_level":{},"stars":0,"local_score":0,"last_star_ts":"0","global_score":0,"id":"1286830"},"463829":{"stars":0,"name":"Cyrol","completion_day_level":{},"id":"463829","local_score":0,"last_star_ts":"0","global_score":0},"890125":{"stars":2,"name":"scorphus","completion_day_level":{"1":{"2":{"get_star_ts":1638337997},"1":{"get_star_ts":1638336308}}},"id":"890125","last_star_ts":1638337997,"global_score":0,"local_score":172},"1351250":{"id":"1351250","last_star_ts":1638336621,"local_score":179,"global_score":0,"stars":2,"name":"Guillaume Gandon","completion_day_level":{"1":{"2":{"get_star_ts":1638336621},"1":{"get_star_ts":1638336006}}}},"1038233":{"stars":0,"completion_day_level":{},"name":"Lost","id":"1038233","last_star_ts":"0","local_score":0,"global_score":0},"1541962":{"last_star_ts":1638356702,"global_score":0,"local_score":150,"id":"1541962","completion_day_level":{"1":{"1":{"get_star_ts":1638355973},"2":{"get_star_ts":1638356702}}},"name":null,"stars":2},"993513":{"id":"993513","last_star_ts":"0","local_score":0,"global_score":0,"stars":0,"completion_day_level":{},"name":"Yuvraj.M"},"1037478":{"id":"1037478","last_star_ts":"0","local_score":0,"global_score":0,"stars":0,"completion_day_level":{},"name":null},"978282":{"stars":0,"name":"Shizuku-Asami","completion_day_level":{},"id":"978282","last_star_ts":"0","local_score":0,"global_score":0},"1005063":{"name":"Mikkerix","completion_day_level":{},"stars":0,"local_score":0,"last_star_ts":"0","global_score":0,"id":"1005063"},"1237820":{"global_score":0,"last_star_ts":"0","local_score":0,"id":"1237820","completion_day_level":{},"name":"Alldrich","stars":0},"985047":{"id":"985047","local_score":136,"last_star_ts":1638368847,"global_score":0,"stars":2,"completion_day_level":{"1":{"1":{"get_star_ts":1638368500},"2":{"get_star_ts":1638368847}}},"name":"maciejors"},"645485":{"stars":2,"name":"aravk33","completion_day_level":{"1":{"2":{"get_star_ts":1638335444},"1":{"get_star_ts":1638335005}}},"id":"645485","global_score":0,"last_star_ts":1638335444,"local_score":192},"976874":{"last_star_ts":"0","global_score":0,"local_score":0,"id":"976874","name":"pepperoni505","completion_day_level":{},"stars":0},"993192":{"last_star_ts":"0","local_score":0,"global_score":0,"id":"993192","completion_day_level":{},"name":"Savitr Chauhan","stars":0},"986492":{"id":"986492","local_score":0,"last_star_ts":"0","global_score":0,"stars":0,"name":"Marty","completion_day_level":{}},"1506833":{"completion_day_level":{},"name":"Akayiz","stars":0,"last_star_ts":"0","local_score":0,"global_score":0,"id":"1506833"},"984928":{"last_star_ts":"0","local_score":0,"global_score":0,"id":"984928","name":"Kqzz","completion_day_level":{},"stars":0},"957532":{"last_star_ts":"0","global_score":0,"local_score":0,"id":"957532","completion_day_level":{},"name":"janine9vn","stars":0},"705845":{"last_star_ts":1638335462,"local_score":193,"global_score":0,"id":"705845","completion_day_level":{"1":{"2":{"get_star_ts":1638335462},"1":{"get_star_ts":1638334958}}},"name":"xelf","stars":2},"1569575":{"name":null,"completion_day_level":{"1":{"2":{"get_star_ts":1638335560},"1":{"get_star_ts":1638335365}}},"stars":2,"last_star_ts":1638335560,"local_score":182,"global_score":0,"id":"1569575"},"644694":{"name":"Blockguy24","completion_day_level":{},"stars":0,"local_score":0,"last_star_ts":"0","global_score":0,"id":"644694"},"410918":{"global_score":0,"last_star_ts":1638366433,"local_score":138,"id":"410918","name":"Poke Poke","completion_day_level":{"1":{"1":{"get_star_ts":1638365919},"2":{"get_star_ts":1638366433}}},"stars":2},"1528908":{"global_score":0,"last_star_ts":"0","local_score":0,"id":"1528908","completion_day_level":{},"name":null,"stars":0},"549712":{"id":"549712","global_score":0,"last_star_ts":"0","local_score":0,"stars":0,"completion_day_level":{},"name":"[GD] Newbie"},"1506835":{"completion_day_level":{},"name":"kamire30","stars":0,"global_score":0,"last_star_ts":"0","local_score":0,"id":"1506835"},"1482429":{"stars":2,"name":"Moonrise","completion_day_level":{"1":{"1":{"get_star_ts":1638356925},"2":{"get_star_ts":1638359692}}},"id":"1482429","last_star_ts":1638359692,"global_score":0,"local_score":147},"1513376":{"stars":2,"completion_day_level":{"1":{"2":{"get_star_ts":1638343713},"1":{"get_star_ts":1638341406}}},"name":"Ketan Amrute","id":"1513376","local_score":159,"last_star_ts":1638343713,"global_score":0},"1094215":{"global_score":0,"last_star_ts":1638340782,"local_score":165,"id":"1094215","completion_day_level":{"1":{"1":{"get_star_ts":1638340219},"2":{"get_star_ts":1638340782}}},"name":"ThatOtherAndrew","stars":2},"991404":{"global_score":0,"last_star_ts":"0","local_score":0,"id":"991404","name":"Poke Master","completion_day_level":{},"stars":0},"1023426":{"global_score":0,"last_star_ts":"0","local_score":0,"id":"1023426","completion_day_level":{},"name":"luci-py","stars":0},"993839":{"global_score":0,"last_star_ts":"0","local_score":0,"id":"993839","completion_day_level":{},"name":"samridh semwal","stars":0},"668445":{"stars":2,"name":"MikeRodeman","completion_day_level":{"1":{"2":{"get_star_ts":1638341713},"1":{"get_star_ts":1638341154}}},"id":"668445","global_score":0,"last_star_ts":1638341713,"local_score":162},"1518134":{"global_score":0,"last_star_ts":"0","local_score":0,"id":"1518134","completion_day_level":{},"name":"rami zyano","stars":0},"976597":{"id":"976597","global_score":0,"last_star_ts":"0","local_score":0,"stars":0,"completion_day_level":{},"name":"Azhaan"},"1044088":{"global_score":0,"last_star_ts":"0","local_score":0,"id":"1044088","completion_day_level":{},"name":"AltNyx","stars":0},"1160887":{"id":"1160887","last_star_ts":"0","local_score":0,"global_score":0,"stars":0,"completion_day_level":{},"name":null},"1142411":{"last_star_ts":1638360527,"local_score":72,"global_score":0,"id":"1142411","name":"ItsNil","completion_day_level":{"1":{"1":{"get_star_ts":1638360527}}},"stars":1},"976599":{"id":"976599","last_star_ts":"0","global_score":0,"local_score":0,"stars":0,"completion_day_level":{},"name":null},"1445104":{"name":"TheLegendBeacon","completion_day_level":{"1":{"2":{"get_star_ts":1638337662},"1":{"get_star_ts":1638336612}}},"stars":2,"last_star_ts":1638337662,"local_score":172,"global_score":0,"id":"1445104"},"998732":{"stars":2,"name":"lhvy","completion_day_level":{"1":{"1":{"get_star_ts":1638335027},"2":{"get_star_ts":1638341321}}},"id":"998732","last_star_ts":1638341321,"global_score":0,"local_score":178},"1404703":{"last_star_ts":"0","local_score":0,"global_score":0,"id":"1404703","name":"shon","completion_day_level":{},"stars":0},"1517547":{"id":"1517547","last_star_ts":"0","local_score":0,"global_score":0,"stars":0,"completion_day_level":{},"name":"OSEP"},"977796":{"global_score":0,"last_star_ts":"0","local_score":0,"id":"977796","name":"Jack92829","completion_day_level":{},"stars":0},"997602":{"name":"Raghav Agarwal","completion_day_level":{},"stars":0,"last_star_ts":"0","global_score":0,"local_score":0,"id":"997602"},"990092":{"stars":2,"completion_day_level":{"1":{"2":{"get_star_ts":1638363456},"1":{"get_star_ts":1638362678}}},"name":"Jay Madden","id":"990092","last_star_ts":1638363456,"global_score":0,"local_score":143},"1566370":{"name":"will803","completion_day_level":{},"stars":0,"last_star_ts":"0","global_score":0,"local_score":0,"id":"1566370"},"650621":{"name":"smgaller","completion_day_level":{"1":{"1":{"get_star_ts":1638335132},"2":{"get_star_ts":1638335316}}},"stars":2,"local_score":192,"last_star_ts":1638335316,"global_score":0,"id":"650621"},"976670":{"id":"976670","last_star_ts":"0","global_score":0,"local_score":0,"stars":0,"name":"JoshW-7","completion_day_level":{}},"1510442":{"stars":0,"completion_day_level":{},"name":"evaldasJankus","id":"1510442","local_score":0,"last_star_ts":"0","global_score":0},"987450":{"id":"987450","last_star_ts":"0","local_score":0,"global_score":0,"stars":0,"name":"acco4321","completion_day_level":{}},"1041545":{"id":"1041545","global_score":0,"last_star_ts":"0","local_score":0,"stars":0,"name":"193 51 Shon Noronha","completion_day_level":{}},"526278":{"global_score":0,"last_star_ts":1638359455,"local_score":147,"id":"526278","name":"dzil123","completion_day_level":{"1":{"2":{"get_star_ts":1638359455},"1":{"get_star_ts":1638358441}}},"stars":2},"991380":{"completion_day_level":{},"name":"Mattwmaster58","stars":0,"last_star_ts":"0","global_score":0,"local_score":0,"id":"991380"},"1107116":{"name":"Juras Kumar","completion_day_level":{},"stars":0,"last_star_ts":"0","global_score":0,"local_score":0,"id":"1107116"},"1418851":{"id":"1418851","global_score":0,"last_star_ts":1638335516,"local_score":191,"stars":2,"completion_day_level":{"1":{"2":{"get_star_ts":1638335516},"1":{"get_star_ts":1638334982}}},"name":"Crowthebird"},"1010034":{"stars":0,"completion_day_level":{},"name":"Mix-Anik","id":"1010034","global_score":0,"last_star_ts":"0","local_score":0},"1301492":{"id":"1301492","last_star_ts":"0","local_score":0,"global_score":0,"stars":0,"name":"trolling-on-the-Moon","completion_day_level":{}},"652753":{"global_score":0,"last_star_ts":"0","local_score":0,"id":"652753","name":"Sebastiaan Zeeff","completion_day_level":{},"stars":0},"977055":{"last_star_ts":"0","global_score":0,"local_score":0,"id":"977055","name":"mhxion","completion_day_level":{},"stars":0},"1506821":{"stars":2,"name":"HiPeople21","completion_day_level":{"1":{"1":{"get_star_ts":1638363385},"2":{"get_star_ts":1638363858}}},"id":"1506821","global_score":0,"last_star_ts":1638363858,"local_score":141},"954572":{"last_star_ts":"0","global_score":0,"local_score":0,"id":"954572","name":null,"completion_day_level":{},"stars":0},"667270":{"stars":2,"completion_day_level":{"1":{"2":{"get_star_ts":1638339705},"1":{"get_star_ts":1638338570}}},"name":"PythonTryHard","id":"667270","last_star_ts":1638339705,"global_score":0,"local_score":167},"1563793":{"global_score":0,"last_star_ts":1638370402,"local_score":65,"id":"1563793","completion_day_level":{"1":{"1":{"get_star_ts":1638370402}}},"name":"SkyTheCodeMaster","stars":1},"1039278":{"local_score":0,"last_star_ts":"0","global_score":0,"id":"1039278","completion_day_level":{},"name":"BobDotCom","stars":0},"1558831":{"global_score":0,"last_star_ts":"0","local_score":0,"id":"1558831","name":"Pink Unicorn","completion_day_level":{},"stars":0},"144137":{"completion_day_level":{},"name":"JoshKarpel","stars":0,"last_star_ts":"0","global_score":0,"local_score":0,"id":"144137"},"957800":{"id":"957800","last_star_ts":1638335333,"local_score":190,"global_score":0,"stars":2,"name":"Mushinako","completion_day_level":{"1":{"1":{"get_star_ts":1638335180},"2":{"get_star_ts":1638335333}}}},"1533104":{"stars":2,"name":"gibbids","completion_day_level":{"1":{"1":{"get_star_ts":1638336122},"2":{"get_star_ts":1638337434}}},"id":"1533104","global_score":0,"last_star_ts":1638337434,"local_score":177},"422097":{"name":"lemonsaurus","completion_day_level":{},"stars":0,"global_score":0,"last_star_ts":"0","local_score":0,"id":"422097"},"1006760":{"stars":0,"completion_day_level":{},"name":"shot607","id":"1006760","last_star_ts":"0","local_score":0,"global_score":0},"374226":{"name":"muddyfish","completion_day_level":{"1":{"1":{"get_star_ts":1638349280},"2":{"get_star_ts":1638349522}}},"stars":2,"global_score":0,"last_star_ts":1638349522,"local_score":153,"id":"374226"},"653043":{"id":"653043","last_star_ts":1638335928,"local_score":182,"global_score":0,"stars":2,"name":"nlantau","completion_day_level":{"1":{"2":{"get_star_ts":1638335928},"1":{"get_star_ts":1638335356}}}},"1024315":{"completion_day_level":{},"name":"Bogdan","stars":0,"local_score":0,"last_star_ts":"0","global_score":0,"id":"1024315"},"1117418":{"stars":0,"name":"Jeremy Gabbard","completion_day_level":{},"id":"1117418","last_star_ts":"0","local_score":0,"global_score":0},"111628":{"last_star_ts":"0","local_score":0,"global_score":0,"id":"111628","completion_day_level":{},"name":"arknave","stars":0},"977153":{"stars":0,"name":"Iqrar99","completion_day_level":{},"id":"977153","local_score":0,"last_star_ts":"0","global_score":0},"1067953":{"global_score":0,"last_star_ts":"0","local_score":0,"id":"1067953","name":"Lunafyy","completion_day_level":{},"stars":0},"1575801":{"last_star_ts":1638342639,"global_score":0,"local_score":159,"id":"1575801","completion_day_level":{"1":{"2":{"get_star_ts":1638342639},"1":{"get_star_ts":1638342185}}},"name":"cupOfTeaInc","stars":2},"1507686":{"last_star_ts":1638354345,"global_score":0,"local_score":154,"id":"1507686","name":"yu sen lee","completion_day_level":{"1":{"1":{"get_star_ts":1638348752},"2":{"get_star_ts":1638354345}}},"stars":2},"1568085":{"last_star_ts":1638337746,"global_score":0,"local_score":170,"id":"1568085","completion_day_level":{"1":{"1":{"get_star_ts":1638337139},"2":{"get_star_ts":1638337746}}},"name":"InviBull","stars":2},"990417":{"name":"Nathan-Binkley","completion_day_level":{},"stars":0,"global_score":0,"last_star_ts":"0","local_score":0,"id":"990417"},"1059969":{"completion_day_level":{},"name":"PanTrakX","stars":0,"last_star_ts":"0","local_score":0,"global_score":0,"id":"1059969"}}}""")

LEADERBOARD_ENDPOINT = 'https://adventofcode.com/2021/leaderboard/private/view/990092.json'
ICON_URL = 'https://camo.githubusercontent.com/5dd06562878c98a85ffc0703941a73947b2c2cfafa7f1f3875e7de7aa39c01bb/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f45467332316d30585941496a7134543f666f726d61743d6a7067266e616d653d6c61726765'

class LeaderboardCog(commands.Cog):

    def __init__(self, bot: commands.Bot):
        self.bot = bot
        self.update_leaderboard.start()

    @tasks.loop(minutes=15)
    async def update_leaderboard(self):
        channel: discord.TextChannel = self.bot.get_channel(self.bot.config['LeaderboardChannel'])

        try:
            leaderboard_message = await channel.fetch_message(channel.last_message_id)
        except:
            await channel.send(embed=await self.get_leaderboard_embed)
            return

        foo = await self.get_leaderboard_embed()
        await leaderboard_message.edit(embed=foo)

    async def get_leaderboard_embed(self):
        lb = await self.get_aoc_leaderboard()
        members = [v for k, v in lb['members'].items()]
        members.sort(key=lambda x: x['local_score'], reverse=True)

        bar = []
        for i, g in enumerate(members):
            bar.append(
                f'{i + 1}: Anonymous#{g["id"]} ({g["local_score"]})' if g["name"] is None else f'{i + 1}: {g["name"]} ({g["local_score"]})')
        bar = bar[:20]
        leaders = '\n'.join(bar)

        embed = discord.Embed(title='**Clemson CPSC Advent Of Code Leaderboard!**', color=discord.Colour.green())
        embed.add_field(name='Top 20', value=f'```{leaders}```')
        embed.set_image(url=ICON_URL)
        embed.set_footer(text='This leaderboard will update every 15 minutes')
        return embed

    async def get_aoc_leaderboard(self):
        cookies = {'session': self.bot.config['SessionCookie']}
        async with aiohttp.ClientSession(cookies=cookies) as session:
            async with session.get(LEADERBOARD_ENDPOINT) as resp:
                return await resp.json()


def setup(bot):
    print('loading leaderboard')
    bot.add_cog(LeaderboardCog(bot))
